좋아, **추론이 끼어들 틈이 없도록** 프로젝트의 아이디어→설계→입출력(I/O) 흐름을 **완전 명세** 수준으로 정리했어.
(아래는 “텍스트 캐논(기준 공간)”을 전제로 한 v0 설계이며, *선택적* 변형 경로까지 명확히 분리해 뒀어.)

---

# 0. 프로젝트 목적(고정 진술)

* **목표 A — 저데이터 종 지원:** 데이터가 부족한 종에서도 행동의 **의미**를 알려줄 수 있어야 한다.
* **목표 B — 인간–동물 소통 강화:** 사람이 이해할 수 있는 **자연어 설명**으로 결과를 제공해야 한다.
* **핵심 전략:** 데이터가 많은 종에서 만든 **공통 “의미 지도”(텍스트 임베딩 공간의 앵커들)**를 기준(캐논)으로 고정하고, 데이터가 적은 종은 **자연어 규칙**으로 그 지도에 정합화한다.

---

# 1. 개념 설계(아이디어 흐름 → 설계로 고정)

## 1.1 캐논(기준 공간)

* **정의:** 하나의 **텍스트 임베딩 공간** (단일 텍스트 인코더로 생성, L2 정규화).
* **이유:** 종/기기/환경에 따른 음향적 변이를 배제하고, 의미(semantics)를 직접 비교하기 위함.

## 1.2 앵커(Anchors)

* **행동 앵커(behavior anchors):** 표층 행동의 프로토타입(예: `startle_chirp`, `s_coil_pose`).
* **의미 앵커(meaning anchors, 권장):** 내재 의미의 프로토타입(예: `meaning.alarm_low`, `meaning.exploration`).
* **표현:** 짧은 자연어 설명 → **같은 텍스트 인코더**로 임베딩 → L2 정규화한 벡터를 “랜드마크”로 고정.

## 1.3 자연어 규칙(NL Rules, v0)

* **역할:** 관측 텍스트/메타/간단 특징을 읽어 **문맥 보정 Δ**을 부여(학습 없이 약지도).
* **표현력(스키마 v0):**

  * `positive_pairs` : 핵심 표현 ↔ 앵커 가중치
  * `tie_groups` : 동류 묶음
  * `separate_groups` : 혼동 군집 강제 분리
    *(v1로 가면 if/then 조건과 의미 앵커 가중을 정식 지원하지만, v0에선 규칙을 “유사도 보정”으로만 해석)*

## 1.4 결합/판정(학습 없음)

* **유사도:** 관측 임베딩 `x`와 각 앵커 `a_k`의 코사인 유사도 `sim_k`
* **보정:** 규칙 보정치 `Δ_k` (없으면 0)
* **최종 점수:**
  [
  \textstyle score_k ;=; \alpha \cdot sim_k ;+; \gamma \cdot \Delta_k
  ]
* **제약:** `tie` / `separate` (필요 시 `inhibit`) 적용
* **거부:** `max_k score_k < \tau` → **abstain(보류)**

---

# 2. I/O 흐름(완전 명세; 선택지 포함, 우선순위 명시)

아래 **A 경로**가 “권장/기본(캐논=텍스트)”이며, **B·C**는 선택적 변형이다.

> ⚠️ 어떤 경로를 쓰든 **앵커와 입력은 같은 텍스트 인코더**로 만든 벡터와 **동일 공간**에서 비교되어야 한다.

## A. 권장 경로(텍스트 전용 캐논) — **기본값**

**목적:** 모든 입력을 텍스트로 통일, 캐논 공간에서만 연산.

1. **입력 수집(Input)**

   * 원자료: 오디오/비디오/연구노트
   * 처리: 사람이 읽는 문장 1–2개로 **간결 텍스트 설명** 작성

     * 예) “야간, 짧은 단발 찍—소리 1회, 핸들링 없음, 회피 없음”
   * 함께 수집: `meta`(시간/상황/종), `features`(반복수 등 소수 피처)

2. **표준 관측 레코드(Observation JSONL)**

   * **스키마(필수/선택 포함)**

     ```json
     {
       "id": "string, unique",
       "species": "crestedgecko|cornsnake|unknown",     // 필수
       "text": "string, <= 280 chars",                   // 필수: 간결 설명문
       "meta": {                                         // 선택(권장)
         "time": "day|night|dawn|dusk",
         "context": "free_roam|handled|captured|unknown",
         "locale": "ko|en|... (언어태그)"
       },
       "features": {                                     // 선택
         "repeats": "int >=0",
         "duration_s": "float >=0",
         "intensity": "low|mid|high (선택)"
       }
     }
     ```

     * **제약:** `text`는 관측 사실만(판단/의미 단어 금지: “위협/경계” 등은 쓰지 않음).

3. **임베딩(Embedding)**

   * **인코더:** 단일 텍스트 인코더(다국어 지원 권장).
   * **출력:** `x ∈ R^d` (L2 정규화).
   * **동일 인코더로** 모든 앵커도 사전 임베딩되어 있음.

4. **스코어링(유사도 계산)**

   * 각 앵커 `a_k`에 대해 `sim_k = cos(x, a_k)`.

5. **규칙 평가 → 보정치(Δ) 산출**

   * `positive_pairs`: 텍스트 일부/표현 히트 시 해당 앵커에 +w.
   * `tie_groups`: 동류 앵커 묶음 처리.
   * `separate_groups`: 군집 분리(가까워도 경계 유지).
   * **해석:** v0에서는 모든 규칙 효과를 **Δ**로 환산(숫자 보정치).

6. **점수 결합 & 제약 적용**

   * `score_k = α·sim_k + γ·Δ_k`
   * `tie/separate` 반영, 필요 시 `inhibit`(상호배타)로 동시 후보 차단.

7. **의사결정(Decision)**

   * `s* = max_k score_k`
   * **보류 조건:** `s* < τ`이면 `label="abstain"`
   * **그 외:** Top-1 행동 라벨 반환, **의미 요약**(있다면 의미 앵커 Top-k 병기)

8. **출력 계약(Output JSON)**

   ```json
   {
     "id": "cre_0001",
     "species": "crestedgecko",
     "label": "startle_chirp" ,                // or "abstain"
     "topk": [
       {"anchor":"startle_chirp","score":0.67},
       {"anchor":"distress_chirping","score":0.48},
       {"anchor":"open_mouth_threat","score":0.41}
     ],
     "meaning_topk": [                         // 의미 앵커를 쓰는 경우
       {"anchor":"meaning.alarm_low","score":0.58},
       {"anchor":"meaning.exploration","score":0.22}
     ],
     "confidence": 0.67,
     "reason_log": {
       "sim_top": ["startle_chirp:0.52","distress_chirping:0.44"],
       "rule_hits": ["night_single_prefers_startle"],
       "delta": {"startle_chirp": +0.20}
     },
     "version": {"encoder":"<name>@sha", "ruleset":"crestedgecko@v0.3"}
   }
   ```

   * **설명 가능성:** 어떤 규칙이 얼마 보정했는지 `reason_log`에 남김.

> ✅ 이 경로가 **가장 안전/직관적**이며, 종 간 확장에 **추가 학습 없이** 바로 쓸 수 있음.

---

## B. 텍스트 요약 경로(오디오를 받되 캐논은 텍스트) — **허용/보조**

**목적:** 오디오가 들어오면 **사람 혹은 규칙 기반 추출기로 텍스트 요약**을 먼저 만들고, 이후 A와 동일 처리.

* **1’ 오디오 입력:** `.wav/.mp3` 등
* **2’ 특징 추출(선택):** 반복수/지속시간/버스트 여부 같은 **간단 수치**만 뽑음
* **3’ 요약 생성:**

  * 자동: 규칙 기반 디스크립터 → 템플릿 문장 생성
  * 수동: 관찰자가 문장 작성
* **4’ 이후:** A의 3)~8) 단계 그대로

> ⚠️ 오디오는 **입력 신호**일 뿐, **의미 앵커가 아님**. 임베딩 비교는 **언제나 텍스트 공간**에서만.

---

## C. 공유공간 경로(오디오–텍스트 멀티모달) — **추후 확장(주의)**

**목적:** CLAP 류의 **공유 임베딩**을 쓸 때, 그래도 **텍스트 타워를 캐논**으로 유지.

* **앵커 임베딩:** **텍스트 타워**로만 계산(기준 고정).
* **오디오 투사:** 오디오 타워로 같은 공간에 투사하되, **정규화/온도 보정** 필수.
* **정합화(있으면):** 소수의 검증 쌍으로 선형 정렬(프로크루스/릿지) 1층만 허용.

> ❌ 텍스트 앵커 없이 **오디오 프로토타입**만 쓰거나, 다른 텍스트 인코더를 섞는 것은 금지(공간 불일치).

---

# 3. 파일·스키마 명세(추론 여지 제거)

## 3.1 앵커 파일(YAML)

```yaml
anchors:
  - name: startle_chirp
    prompt: "brief high-pitched single chirp; sudden flinch"
  - name: distress_chirping
    prompt: "2-5 short chirps; avoidance posture"
  # (권장) 공통 의미 앵커
  - name: meaning.alarm_low
    prompt: "low-level alert; brief startle; quick recovery"
```

* **생성 규칙:** 모든 `prompt`는 같은 인코더로 임베딩 → L2 정규화 벡터 캐시.

## 3.2 규칙 파일(v0, YAML)

```yaml
species: crestedgecko

positive_pairs:
  - { text: "single short chirp",           anchor: startle_chirp,       weight: 1.0 }
  - { text: "2-5 short chirps",             anchor: distress_chirping,   weight: 1.0 }

tie_groups:
  - [tail_waving_slow, tail_vibration_rapid]

separate_groups:
  - [[startle_chirp, distress_chirping, open_mouth_threat],
     [fired_down_calm, exploration]]
```

* **허용 단어:** 관측 **표층**(짧다/단발/반복수/포즈 등)만. **의미 단어(“위협/경계”)는 금지**.

---

# 4. 엔진 결합 규격(수식·하이퍼파라미터)

* **코사인 유사도:** `sim_k ∈ [-1, 1]` (L2 정규화로 안정화)
* **규칙 보정치 Δ:** `Δ_k`의 기본 범위 권장 `[-0.3, +0.3]`
* **결합:** `score_k = α·sim_k + γ·Δ_k`

  * **초기값:** `α = 0.15`, `γ = 0.05` (종/도메인별 검증으로 조정)
* **임계값:** `τ ∈ [0.40, 0.70]` (검증셋 F1로 선택)
* **캘리브레이션(권장):** 온도 1개(`T`)로 `score → prob` 보정(플랫).

---

# 5. 종 간 전이(저데이터 종의 절차)

1. **공통 유지:** 텍스트 캐논/인코더, **의미 앵커**(이름·벡터) 변경 금지
2. **최소 보강:** 행동 앵커 2–5개만 추가(진짜 필요한 것)
3. **규칙 작성:** 관측 표현 차이를 **positive_pairs + separate**로 반영
4. **게이트:** `species` 필드로 해당 종 규칙만 활성
5. **검증:** Anchors-only / Rules-only / Both 성능 및 **보류율** 함께 확인

---

# 6. 출력·설명 가능성(Reason Log 포맷)

```json
{
  "input": {"id":"cre_001","text":"야간 단발 짧은 소리 1회", "meta":{"time":"night"}, "features":{"repeats":1}},
  "top1": "startle_chirp",
  "topk": ["startle_chirp:0.67","distress_chirping:0.48","open_mouth_threat:0.41"],
  "sim":  ["startle_chirp:0.52","distress_chirping:0.44"],
  "delta": {"startle_chirp": +0.20},
  "rules_hit": ["night_single_prefers_startle"],
  "abstain": false
}
```

* **목적:** 라벨 근거를 사람이 바로 확인(디버깅/보고서).

---

# 7. 평가 루틴(고정 절차)

* **아블레이션 3종:** Anchors-only(γ=0) / Rules-only(α=0) / Both
* **스윕:** `α×γ` 격자, `τ` 그리드 → **최적 조합** 선정
* **지표:** Top-1/Top-3, 혼동행렬, **보류율–정확도 트레이드오프**
* **황금 I/O 세트(6–8개):** 종별 대표 상황 텍스트 ↔ 기대 라벨 고정 → 드리프트 감시

---

# 8. 흔한 실패와 방지(규칙)

* **오디오를 의미로 사용(금지):** 오디오는 **입력 신호**일 뿐, **의미는 텍스트 캐논에서만**.
* **공간 혼용(금지):** 서로 다른 텍스트 인코더/멀티모달 공간을 **혼합 금지**.
* **표층·의미 혼선:** 규칙·입력 텍스트에 **의미 단어 금지**(표층만 기입).
* **강제 라벨링:** `τ` 미만은 **항상 보류**(unknown/검토) — 신뢰성 핵심.

---

# 9. 이 문서로부터의 실행 요약(한 페이지 치트)

* **입력:** “관측 텍스트 + meta + features” JSONL
* **앵커:** 텍스트 프롬프트 임베딩(행동 + (권장) 의미)
* **규칙:** v0 스키마로 동의어/분리/묶음
* **점수:** `α·sim + γ·Δ`, `τ`로 보류
* **출력:** 행동 라벨 + (선택) 의미 요약 + reason_log
* **평가:** 아블레이션/스윕/황금 I/O

---

## “I/O 흐름이 맞는지”에 대한 결론

* 네가 원하는 “**데이터 많은 종의 의미 지도 → 다른 종 전이**”를 정확히 수행하려면 **A 경로(텍스트 캐논)**가 **정답**이야.
* 오디오를 받아도 **B 경로**처럼 **텍스트 요약을 생성**해 **같은 텍스트 공간**으로 올리면 **전이 논리**가 깨지지 않는다.
* C 경로(공유공간)는 *가능*하지만, 캐논을 **텍스트 타워**로 강제하고 정합화까지 해야 하므로 **추후 확장**으로 미루는 게 안전.

---

## 프로젝트 흐름
* ① 캐논 제작 (Canon: 의미 지도 고정)

목표

종과 상관없이 공유되는 의미 좌표계를 텍스트 임베딩 공간에 고정한다.

절차

인코더 하나 고정

단일 텍스트 인코더(다국어 권장) 선택 → 전 구간 동일 인코더 사용.

임베딩은 L2 정규화.

의미 앵커 세트 설계 (공통)

예: meaning.alarm_low, meaning.alarm_high, meaning.exploration, meaning.courtship …

각 앵커에 짧은 설명문(prompt) 작성 → 인코더로 임베딩 → 벡터 Freeze.

데이터 많은 종의 행동 앵커(선택, 보조)

예: startle_chirp, distress_chirping, s_coil_pose …

역시 텍스트 설명 → 임베딩 → Freeze.

온도 보정(권장)

검증 소수 샘플로 온도 T 1개 추정(과신 방지).

캐논 버전 태그: encoder@sha, anchors@vX.

산출물

configs/anchors/common_meanings.yml (의미 앵커)

(선택) configs/anchors/<species>.yml (행동 앵커)

artifacts/anchors/*.npy (캐시)

docs/CANON.md (의미 축 정의·네이밍 규칙)

체크리스트

 인코더 하나만 사용(앵커/입력 동일)

 의미 앵커 최소 4–6개 정의

 모든 앵커 벡터 L2 정규화 완료

 온도 T 추정(선택)

② 모델 종별 조정 (저데이터 종 전이)

목표

캐논(공통 의미 앵커)은 그대로, 종별 차이는 **행동 앵커 소수 + 자연어 규칙(v0)**만으로 흡수.

절차

행동 앵커 보강(필요 시만)

진짜 필요한 2–5개만 추가(불필요 확장 금지).

자연어 규칙 작성(v0)

positive_pairs: 관측 표현 ↔ 해당 앵커 매핑(핵심 키워드만).

separate_groups: 위협 vs 탐색/차분 등 강제 분리.

tie_groups: 동류 묶음(동률 처리).

규칙 문구는 “표층 사실”만—의미 단어(위협/경계 등) 금지.

종 게이트

관측의 species에 따라 해당 종 규칙만 활성.

점수 결합 고정

score_k = α·sim_k + γ·Δ_k (초기값 α=0.15, γ=0.05)

제약 적용: tie/separate(필요 시 inhibit)

보류 정책(오픈셋)

max(score) < τ → abstain (초기 τ≈0.5 근방에서 검증으로 튜닝).

산출물

configs/rules/<species>_rules.yml (v0 스키마)

docs/SPECIES_ADAPT.md (종별 차이와 규칙 의도 요약)

체크리스트

 규칙에 적힌 앵커명이 실제 앵커와 1:1 일치

 혼동 페어는 separate_groups로 분리

 종 게이트 적용 확인

 α, γ, τ 초기값 기록
 좋아. **프로그램 안 돌리고 수동으로** 검증할 때 쓰는 최소·충분 세트로 정리해줄게. 그대로 따라 하면 돼.

# 수동 검증 프로토콜 (프로그램 불필요)

## 1) 준비물

* **의도 의미(ground truth)**: 각 영상이 유도로 만들고자 한 의미(예: `alarm_low`, `alarm_high`, `exploration`).
* **의미 앵커 목록**(짧은 정의 한 줄씩).
* (선택) **행동→의미 매핑표**: 특정 행동이 어느 의미에 해당하는지 표 1장.

예시 매핑(필요 시 조정):

```
startle_chirp → alarm_low
distress_chirping → alarm_high
s_coil_pose → alarm_high
calm_tongue_flicking → exploration
exploration → exploration
```

---

## 2) 클립 단위 절차 (5단계)

1. **시청**: 영상 전체 1–2회.
2. **표층 설명 기록**: 보이는/들리는 사실만 1~2문장. (의미 단어 금지: “위협/경계/구애” 등 X)
3. **주 행동 결정**: 한 문장으로 핵심 행동 이름(또는 없음/복수).
4. **의미 판정**:

   * 주 행동이 매핑표상 **의도 의미와 같으면 → “일치(meaning)”**
   * 주 행동이 다르지만 **같은 의미로 귀결**되면 → “의미 일치, 행동 불일치(OK)”
   * 행동이 불분명/혼재 → **“보류”**
   * 명백히 다른 의미 → **“불일치”**
5. **신뢰도 메모(1–3점)**: 1=애매, 2=보통, 3=명확.

> 기준: 우리는 **“의미 일치 여부”**가 1순위이고, “행동 라벨 일치”는 보조지표야.

---

## 3) 기록 양식 (복붙해서 쓰는 카드)

아래 블록을 영상마다 하나씩 채워 넣어. (의미 단어는 `의도 의미`/`판정` 칸에만 쓰기)

```
[CLIP REVIEW]
ID: 
종(species):
의도 의미(GT meaning):  alarm_low | alarm_high | exploration | courtship | other

표층 설명(관측 텍스트, 의미 단어 금지):
- 예) 야간, 짧은 단발 '찍' 1회, 핸들링 없음, 회피 없음

주 행동(텍스트 한 줄 또는 목록):
- 예) startle_chirp

판정:
- 의미 일치 / 보류 / 불일치
- (선택) 행동 라벨 일치 여부: 일치 / 불일치 / N/A

신뢰도(1~3):
메모(이상/의문점):
```

---

## 4) 집계(손계산 공식)

* 총 클립 수 `N`, 보류 수 `B`, 평가 대상 `E = N - B`
* **의미 일치율** `= (의미 일치 건수) / E`
* **행동 일치율(보조)** `= (행동 일치 건수) / E`
* **커버리지(coverage)** `= E / N`  (높을수록 보류가 적음)

권장 합격선(예시, 상황 따라 조정):

* 의미 일치율 ≥ **90%** @ 커버리지 ≥ **80%**
* 행동 일치율은 보조로 참고

---

## 5) 판정 가이드(일관성 확보용)

* **보류로 보내라:** 초점 밖/가림/잡음·중첩, “주 행동”을 명확히 못 적겠을 때.
* **의미 일치로 인정:** 행동은 다르지만 같은 의미 축(예: `open-mouth threat` vs `defensive_hiss` 둘 다 `alarm_high`).
* **불일치:** 주 행동이 명확하고, 매핑표상 다른 의미일 때.

---

## 6) 흔한 함정 & 예방

* **라벨 누설 금지:** 표층 설명에 “위협/경계/구애” 같은 의미 단어 쓰지 말기.
* **다중 행동:** 한 클립에 둘 이상이면 **주 행동 1개**만 고르거나 클립을 분할.
* **종 표기 오류:** 종이 틀리면 해석 자체가 흔들림 → 카드 상단에 종을 반드시 기입.

---

원하면 위 카드 양식을 내가 **한글/영문 두 버전**으로 더 깔끔하게 정리해서 한 장짜리 PDF로도 만들어줄게.
