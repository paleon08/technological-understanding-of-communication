TUC 실행 가이드 (PowerShell)

텍스트 캐논·앵커·규칙 기반 종 정합화 워크플로우를 최소 명령어로 문서화했습니다. Windows PowerShell, Conda 환경(tuc) 기준.

0) 전제

Conda 환경 이름: tuc

레포 루트: D:\0.Seoyun\수행평가\커뮤니케이션의 공학적 이해\technological-understanding-of-communication

접두어 정책: 앵커=passage, 질의=query

하위공간: μ,B(projector.npz) 사용 시 앵커 캐시 재생성 필수

권장: python -m tuc.cli ... 형태로 실행(모듈 직접 실행). 필요 시 pip install -e .로 CLI 고정.

1) 공통 준비
conda activate tuc
cd "D:\0.Seoyun\수행평가\커뮤니케이션의 공학적 이해\technological-understanding-of-communication"
$env:PYTHONPATH = "$PWD"  # 로컬 소스 직접 import
2) 하위공간(μ,B) 생성 (최초 1회 또는 변경 시)
python -m tuc.loading_base_model.build_subspace `
  --anchors-yaml configs/anchors/common_meanings.yml `
  --out "$PWD\artifacts\subspace\uB\projector.npz"
하위공간 사용 켜기
$env:TUC_USE_SUBSPACE = "1"
$env:TUC_SUBSPACE_PATH = "$PWD\artifacts\subspace\uB\projector.npz"

다른 하위공간으로 교체할 땐: TUC_SUBSPACE_PATH 변경 → 3단계(앵커 재빌드) 다시 수행.

3) 앵커 재빌드 (항상 passage)

하위공간을 바꾸거나 접두어 정책을 바꿨다면 반드시 재빌드.

Remove-Item "$PWD\artifacts\text_anchors\*" -Force -ErrorAction SilentlyContinue
$env:TUC_E5_MODE = "passage"
python -m tuc.cli build
4) 질의 실행 (항상 query)
$env:TUC_E5_MODE = "query"
python -m tuc.cli query --k 5 --query "질의 문장"

앵커는 passage, 질의는 query를 항상 사용. 섞이면 성능 저하 및 분포 불일치 발생.

5) 한 번만 설치해 CLI 고정하고 싶다면(선택)
python -m pip uninstall -y tuc
python -m pip install -e . --no-build-isolation

이후에는 다음처럼 사용 가능:

$env:TUC_E5_MODE = "passage"; tuc build
$env:TUC_E5_MODE = "query";   tuc query --k 5 --query "질의 문장"
6) 원샷 스크립트(복붙)

하위공간 생성 → 사용 설정 → 앵커 재빌드 → 질의를 한 번에 실행.

conda activate tuc
cd "D:\0.Seoyun\수행평가\커뮤니케이션의 공학적 이해\technological-understanding-of-communication"
$env:PYTHONPATH = "$PWD"


# 하위공간(없으면 생성)
if (-not (Test-Path "$PWD\artifacts\subspace\uB\projector.npz")) {
  python -m tuc.loading_base_model.build_subspace `
    --anchors-yaml configs/anchors/common_meanings.yml `
    --out "$PWD\artifacts\subspace\uB\projector.npz"
}


# 하위공간 사용
$env:TUC_USE_SUBSPACE = "1"
$env:TUC_SUBSPACE_PATH = "$PWD\artifacts\subspace\uB\projector.npz"


# 앵커 재빌드(passag e)
Remove-Item "$PWD\artifacts\text_anchors\*" -Force -ErrorAction SilentlyContinue
$env:TUC_E5_MODE = "passage"
python -m tuc.cli build


# 질의(query)
$env:TUC_E5_MODE = "query"
python -m tuc.cli query --k 5 --query "질의 문장"
7) 스모크 테스트 체크리스트




8) 트러블슈팅

Q1. ModuleNotFoundError: tuc

해결 A: 매번 python -m tuc.cli ... + $env:PYTHONPATH="$PWD" 사용

해결 B: pip install -e .로 로컬 설치

Q2. tuc build가 어떤 때만 동작

where tuc로 중복 stub 확인 → 현재 Conda env의 tuc.exe만 사용

또는 아예 python -m tuc.cli build 사용

Q3. 결과가 들쑥날쑥

모드 확인: build=passage, query=query

하위공간 교체 후 앵커 재빌드 여부 확인

정규화 순서: (μ 빼기) → (Bᵀ 투영) → (L2)

9) 안전한 대안(권장, 코드 수정)

model_build.py: encode_text(texts, mode="passage")로 고정

search.py: encode_text([q], mode="query")[0]로 고정

이렇게 하면 환경변수 토글 실수를 원천 차단할 수 있습니다.